<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanlÄ± Destek - BÃ¼yÃ¼lÃ¼ Sepet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="snowflakes" aria-hidden="true"><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div></div>
    <header>
        <div class="navbar">
            <div class="logo">
                <h1><a href="/" style="text-decoration:none; color:inherit;">ğŸ BÃ¼yÃ¼lÃ¼ Sepet âœ¨</a></h1>
            </div>
            <div class="search-bar-container">
                <form action="/urunler" method="GET" class="search-form">
                    <input type="text" name="search" placeholder="ÃœrÃ¼n ara..." class="search-input">
                    <button type="submit" class="search-button">ğŸ”</button>
                </form>
            </div>
            <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
            <div class="nav-links" id="navMenu">
                <a href="/">Ana Sayfa</a>
                <a href="/urunler">ÃœrÃ¼nler</a>
                <a href="/urunler?kategori=cocuk" class="kids-link">ğŸˆ Ã‡ocuklar Ä°Ã§in</a>
                <a href="/hakkimizda">HakkÄ±mÄ±zda</a>
                <a href="/iletisim">Ä°letiÅŸim</a>
                <a href="/sepet" class="cart-fab">ğŸ›’ Sepet</a>
                {% if current_user.is_authenticated %}
                    <a href="/favoriler">â¤ï¸ Favoriler</a>
                    <a href="/support" class="active">ğŸ’¬ Destek</a>
                    <a href="/game" class="forest-link">ğŸŒ² BÃ¼yÃ¼lÃ¼ Orman</a>
                    <a href="/profile">ğŸ‘¤ {{ current_user.name.split()[0][0]}}.{{ current_user.name.split()[1][0] if current_user.name.split()|length > 1 else 'U' }}</a>
                    <a href="/logout">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
                {% else %}
                    <a href="/login">ğŸ” GiriÅŸ</a>
                    <a href="/register">âœ¨ KayÄ±t Ol</a>
                {% endif %}
            </div>
        </div>
    </header>
    <script>
        function toggleMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('navMenu');
            const toggle = document.querySelector('.menu-toggle');
            if (!menu.contains(event.target) && !toggle.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // Search autocomplete system
        const products = [
            {id: 1, name: 'Sihirli Kar KÃ¼resi', category: 'Dekorasyon', icon: 'ğŸ”®'},
            {id: 2, name: 'Peri IÅŸÄ±ÄŸÄ± LambasÄ±', category: 'AydÄ±nlatma', icon: 'ğŸ’¡'},
            {id: 3, name: 'Elfler Ä°Ã§in El YapÄ±mÄ± AtkÄ±', category: 'Giyim', icon: 'ğŸ§£'},
            {id: 4, name: 'Ã‡am KozalaÄŸÄ± SÃ¼s Seti', category: 'Dekorasyon', icon: 'ğŸŒ²'},
            {id: 5, name: 'Geyik PeluÅŸ Oyuncak', category: 'Ã‡ocuk', icon: 'ğŸ¦Œ'},
            {id: 6, name: 'YÄ±ldÄ±z Tozlu Mum Seti', category: 'Dekorasyon', icon: 'ğŸ•¯ï¸'},
            {id: 7, name: 'BÃ¼yÃ¼lÃ¼ Sepet Ã‡ayÄ±', category: 'Yiyecek', icon: 'â˜•'},
            {id: 8, name: 'Sincap PeluÅŸ Ailesi', category: 'Ã‡ocuk', icon: 'ğŸ¿ï¸'},
            {id: 9, name: 'AhÅŸap KulÃ¼be MÃ¼zik Kutusu', category: 'Dekorasyon', icon: 'ğŸ '},
            {id: 10, name: 'Kar Tanesi KÃ¼pe Seti', category: 'Aksesuar', icon: 'ğŸ’'},
            {id: 11, name: 'Orman Ninnileri KitabÄ±', category: 'Ã‡ocuk', icon: 'ğŸ“–'},
            {id: 12, name: 'BÃ¼yÃ¼lÃ¼ Teraryum', category: 'Bitki', icon: 'ğŸŒ¿'},
            {id: 13, name: 'Kristal YÄ±ldÄ±z Kolye', category: 'Aksesuar', icon: 'â­'},
            {id: 14, name: 'Sihirli Mantar Lamba', category: 'AydÄ±nlatma', icon: 'ğŸ„'},
            {id: 15, name: 'Orman Eldiveni Seti', category: 'Giyim', icon: 'ğŸ§¤'},
            {id: 16, name: 'Noel Baba KapÄ± SÃ¼sÃ¼', category: 'Dekorasyon', icon: 'ğŸ…'},
            {id: 17, name: 'BÃ¼yÃ¼lÃ¼ Ã‡ikolata Kutusu', category: 'Yiyecek', icon: 'ğŸ«'},
            {id: 18, name: 'Kardan Adam PeluÅŸ', category: 'Ã‡ocuk', icon: 'â›„'},
            {id: 19, name: 'YÄ±lbaÅŸÄ± AÄŸacÄ± Topper YÄ±ldÄ±z', category: 'Dekorasyon', icon: 'ğŸŒŸ'},
            {id: 20, name: 'Peri KanatlÄ± YastÄ±k', category: 'Aksesuar', icon: 'ğŸ¦‹'},
            {id: 21, name: 'Elf ÅapkasÄ±', category: 'Giyim', icon: 'ğŸ©'},
            {id: 22, name: 'Orman Hikayeleri Seti', category: 'Ã‡ocuk', icon: 'ğŸ“š'},
            {id: 23, name: 'Mini Ã‡am AÄŸacÄ±', category: 'Bitki', icon: 'ğŸŒ²'},
            {id: 24, name: 'IÅŸÄ±klÄ± Geyik FigÃ¼rÃ¼', category: 'Dekorasyon', icon: 'ğŸ¦Œ'}
        ];

        const searchInput = document.querySelector('.search-input');
        const searchForm = document.querySelector('.search-form');
        let searchSuggestions = document.getElementById('searchSuggestions');
        
        // Create suggestions container if not exists
        if (!searchSuggestions && searchForm) {
            searchSuggestions = document.createElement('div');
            searchSuggestions.id = 'searchSuggestions';
            searchSuggestions.className = 'search-suggestions';
            searchForm.parentElement.appendChild(searchSuggestions);
        }

        if (searchInput && searchSuggestions) {
            searchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (query.length === 0) {
                    searchSuggestions.classList.remove('active');
                    return;
                }

                const results = products.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.category.toLowerCase().includes(query)
                ).slice(0, 8);

                if (results.length > 0) {
                    searchSuggestions.innerHTML = results.map(item => `
                        <div class="suggestion-item" onclick="selectSuggestion(${item.id})">
                            <span class="suggestion-icon">${item.icon}</span>
                            <span class="suggestion-text">${item.name}</span>
                            <span class="suggestion-category">${item.category}</span>
                        </div>
                    `).join('');
                    searchSuggestions.classList.add('active');
                } else {
                    searchSuggestions.classList.remove('active');
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                    searchSuggestions.classList.remove('active');
                }
            });
        }

        function selectSuggestion(productId) {
            searchSuggestions.classList.remove('active');
            window.location.href = '/urun/' + productId;
        }
    </script>
    <main class="support-page">
        <div class="container">
            <h1 class="page-title">ğŸ’¬ CanlÄ± Destek - BÃ¼yÃ¼lÃ¼ Sepet AsistanÄ±</h1>
            <p class="page-subtitle">Size yardÄ±mcÄ± olmak iÃ§in buradayÄ±m! ğŸ§šâ€â™€ï¸</p>

            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-status">
                        <span class="online-dot">ğŸŸ¢</span>
                        <div class="status-text">
                            <p class="status-title">Peri YardÄ±mcÄ±</p>
                            <p class="status-subtitle">CanlÄ± sohbet</p>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    {% if messages %}
                        {% for msg in messages %}
                            <div class="chat-message {% if msg.is_user %}user-message{% else %}bot-message{% endif %}">
                                <div class="message-avatar">{% if msg.is_user %}ğŸ‘¤{% else %}ğŸ§šâ€â™€ï¸{% endif %}</div>
                                <div class="message-content">
                                    <p>{{ msg.message }}</p>
                                    <span class="message-time">{{ msg.created_at.strftime('%H:%M') }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="chat-message bot-message welcome-message">
                            <div class="message-avatar">ğŸ§šâ€â™€ï¸</div>
                            <div class="message-content">
                                <p><strong>Merhaba {{ current_user.name.split()[0] }}! ğŸ„</strong></p>
                                <p>BÃ¼yÃ¼lÃ¼ Sepet asistanÄ±yÄ±m. Size yardÄ±mcÄ± olmak iÃ§in buradayÄ±m!</p>
                                <p style="margin-top: 12px; font-size: 0.9em; color: #666;">ğŸ’¡ Ä°pucu: "yardÄ±m" yazarak tÃ¼m konularÄ± gÃ¶rebilirsiniz ya da doÄŸrudan sorunuzu sorabilirsiz!</p>
                                <span class="message-time">Åimdi</span>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
                    <div class="input-wrapper">
                        <input type="text" id="messageInput" placeholder="MesajÄ±nÄ±z..." autocomplete="off" required>
                        <button type="submit" class="btn-send">â¤</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        // Sayfa yÃ¼klendiÄŸinde en alta kaydÄ±r
        window.addEventListener('load', () => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        const sendButton = document.querySelector('.btn-send');
        let isLoading = false;

        function sendMessage(event) {
            event.preventDefault();

            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            sendButton.disabled = true;
            sendButton.textContent = 'ğŸ”„';
            messageInput.disabled = true;

            // KullanÄ±cÄ± mesajÄ±nÄ± ekle
            addMessage(message, true, new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
            messageInput.value = '';

            // Loading gÃ¶stergesi ekle - typing animasyonu
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message bot-message loading-message';
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ğŸ§šâ€â™€ï¸</div>
                <div class="message-content">
                    <div class="typing-bubble">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // API'ye gÃ¶nder
            fetch('/api/support/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                // Delay ile bot cevabÄ± gÃ¶ster (3 saniye)
                const delayTime = data.delay || 3000;
                
                setTimeout(() => {
                    // Loading mesajÄ±nÄ± kaldÄ±r
                    const loadingElement = document.getElementById('loading-indicator');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Bot cevabÄ±nÄ± ekle
                    addMessage(data.bot_response.message, false, data.bot_response.created_at);
                    
                    // Durum sÄ±fÄ±rla
                    isLoading = false;
                    sendButton.disabled = false;
                    sendButton.textContent = 'â¤';
                    messageInput.disabled = false;
                    messageInput.focus();
                }, delayTime);
            })
            .catch(error => {
                console.error('Error:', error);
                const loadingElement = document.getElementById('loading-indicator');
                if (loadingElement) {
                    loadingElement.remove();
                }
                addMessage('âš ï¸ BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar deneyin veya mÃ¼ÅŸteri hizmetine ulaÅŸÄ±n: +90 (555) 123 45 67', false, new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
                
                isLoading = false;
                sendButton.disabled = false;
                sendButton.textContent = 'â¤';
                messageInput.disabled = false;
                messageInput.focus();
            });
        }

        function addMessage(text, isUser, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.style.animation = 'slideIn 0.3s ease';

            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ§šâ€â™€ï¸'}</div>
                <div class="message-content">
                    <p>${text.replace(/\n/g, '<br>')}</p>
                    <span class="message-time">${time}</span>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            // Smooth scroll
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }
        
        // Enter tuÅŸu ile gÃ¶nder
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                sendMessage(e);
            }
        });
    </script>

    <footer><div class="footer-content"><div class="footer-section"><h3>ğŸ BÃ¼yÃ¼lÃ¼ Sepet</h3><p>YÄ±lbaÅŸÄ±nÄ±n sihirli dÃ¼nyasÄ±na hoÅŸ geldiniz!</p></div><div class="footer-section"><h3>Ä°letiÅŸim</h3><p>ğŸ“§ info@buyuluorman.com</p><p>ğŸ“± +90 (555) 123 45 67</p></div></div><div class="footer-bottom"><p>&copy; 2024 BÃ¼yÃ¼lÃ¼ Sepet - YÄ±lbaÅŸÄ± AlÄ±ÅŸveriÅŸ MaÄŸazasÄ±. TÃ¼m haklarÄ± saklÄ±dÄ±r. âœ¨ğŸ„</p></div></footer>
</body>
</html>
